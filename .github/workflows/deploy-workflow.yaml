name: Build and Deploy with Helm using Docker Hub

on:
  workflow_dispatch:

env:
  IMAGE_NAME: foaad                           # ðŸ‘ˆ name of your image

jobs:
  docker-build:
    name: docker build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Hub Login
      uses: docker/login-action@v3
      with:
       username: ${{ vars.USER_NAME }}
       password: ${{ secrets.PASSWORD }}

    - name: Build Docker Image for Testing
      uses: docker/build-push-action@v4
      with:
       context: .
       push: true
       tags: ${{ vars.USER_NAME}}/flask-kubernetes:${{ github.sha }}

  deploy-helm-chart:
    needs: docker-build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Helm
      uses: azure/setup-helm@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Configure kubectl
      run: |
         echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig
         chmod 600 kubeconfig
         export KUBECONFIG=$(pwd)/kubeconfig
         kubectl cluster-info
         kubectl get nodes

    - name: Deploy Helm chart
      run: |
        helm upgrade --install flask-kubernetes-release ./helm \
        --set image.repository=${{ vars.USER_NAME}}/flask-kubernetes \
        --set image.tag=${{ github.sha }} \
        --namespace foaad \
        --create-namespace \
        --kubeconfig kubeconfig \

    
    - name: Debug Deployment Issues
      run: |
        echo "### Pod Details ###"
        kubectl get pods -l place=iti,name=foaad --namespace foaad --kubeconfig kubeconfig -o wide
        
        echo "## Pod Events ##"
        kubectl describe pods -l place=iti,name=foaad --namespace foaad --kubeconfig kubeconfig
        
        echo "## Deployment Events ##"
        kubectl describe deployment flask-kubernetes-release-deployment --namespace foaad --kubeconfig kubeconfig

    - name: Verify Deployment
      run: |
       echo "### Checking Rollout Status ###"
       kubectl rollout status deployment/flask-kubernetes-release-deployment --namespace foaad --kubeconfig kubeconfig || true
    
       echo "### Checking Pods ###"
       kubectl get pods -l place=iti,name=foaad -o wide --namespace foaad --kubeconfig kubeconfig 
      
       echo "### pods logs ###"
        kubectl logs -l place=iti,name=foaad --namespace foaad --kubeconfig kubeconfig || echo "No logs available yet"

       echo "### Checking Services ###"
       kubectl get svc -l place=iti,name=foaad --namespace foaad --kubeconfig kubeconfig

       echo "### Helm Resources ###"
       helm get manifest flask-kubernetes-release --namespace foaad --kubeconfig kubeconfig
    
       echo "### Helm Status ###"
       helm status flask-kubernetes-release --namespace foaad --kubeconfig kubeconfig